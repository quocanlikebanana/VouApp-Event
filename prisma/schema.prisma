// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
    // uncomment next line if you use Prisma <5.10
    // directUrl = env("DATABASE_URL_UNPOOLED")
}

enum EventStatus {
    PENDING
    APPROVED
    REJECTED
    STARTED
    ENDED
}

model Event {
    id          Int         @id @default(autoincrement())
    partnerId   Int
    partnerName String
    name        String
    description String?
    startDate   DateTime?
    endDate     DateTime?
    status      EventStatus

    UserJoinEvents      User_Join_Event[]
    PuzzleSet_Of_Events PuzzleSet_Of_Event[]
    Game_Of_Events      Game_Of_Event[]
    Promotion_Of_Events Promotion_Of_Event[]
}

model User_Join_Event {
    id            Int      @id @default(autoincrement())
    userId        Int
    userFirstName String
    userLastName  String
    userEmail     String
    userFacebook  String?
    joinDate      DateTime

    eventId Int
    Event   Event @relation(fields: [eventId], references: [id])

    UserJoinEvent_Has_Puzzles                UserJoinEvent_Has_PuzzleOfEvent[]
    UserJoinEvent_Exchange_PuzzleSetOfEvents UserJoinEvent_Exchange_PuzzleSetOfEvent[]
    UserJoinEvent_Join_GameOfEvent           UserJoinEvent_Join_GameOfEvent[]
    UserJoinEvent_Has_PromotionOfEvent       UserJoinEvent_Has_PromotionOfEvent[]

    @@unique([userId, eventId])
}

model UserJoinEvent_Has_PuzzleOfEvent {
    id       Int @id @default(autoincrement())
    quantity Int

    userJoinEventId Int
    UserJoinEvent   User_Join_Event @relation(fields: [userJoinEventId], references: [id])

    puzzleOfEventId Int
    Puzzle_Of_Event Puzzle_Of_Event @relation(fields: [puzzleOfEventId], references: [id])

    @@unique([userJoinEventId, puzzleOfEventId])
}

model UserJoinEvent_Has_PromotionOfEvent {
    id       Int @id @default(autoincrement())
    quantity Int

    promotionOfEventId Int
    PromotionOfEvent   Promotion_Of_Event @relation(fields: [promotionOfEventId], references: [id])

    userJoinEventId Int
    UserJoinEvent   User_Join_Event @relation(fields: [userJoinEventId], references: [id])

    @@unique([promotionOfEventId, userJoinEventId])
}

model UserJoinEvent_Exchange_PuzzleSetOfEvent {
    id           Int      @id @default(autoincrement())
    exchangeDate DateTime
    isWin        Boolean

    PuzzleSet_Of_Event   PuzzleSet_Of_Event? @relation(fields: [puzzleSet_Of_EventId], references: [id])
    puzzleSet_Of_EventId Int?

    UserJoinEvent   User_Join_Event? @relation(fields: [userJoinEventId], references: [id])
    userJoinEventId Int?
}

// Array of PuzzleSet, outside.
model Puzzle_Of_Event {
    id         Int    @id @default(autoincrement())
    puzzleId   Int
    puzzleName String

    puzzleSetOfEventId Int
    PuzzleSet_Of_Event PuzzleSet_Of_Event @relation(fields: [puzzleSetOfEventId], references: [id])

    UserJoinEvent_Has_PuzzleOfEvent UserJoinEvent_Has_PuzzleOfEvent[]

    @@unique([puzzleId, puzzleSetOfEventId])
}

model PuzzleSet_Of_Event {
    id            Int    @id @default(autoincrement())
    puzzleSetId   Int
    puzzleSetName String

    eventId Int
    Event   Event @relation(fields: [eventId], references: [id])

    Puzzle_Of_Events                        Puzzle_Of_Event[]
    PromotionOfEvent_For_PuzzleSetOfEvents  PromotionOfEvent_Prize_PuzzleSetOfEvent[]
    UserJoinEvent_Exchange_PuzzleSetOfEvent UserJoinEvent_Exchange_PuzzleSetOfEvent[]

    @@unique([puzzleSetId, eventId])
}

model PromotionOfEvent_Prize_PuzzleSetOfEvent {
    id       Int @id @default(autoincrement())
    quantity Int

    puzzleSetOfEventId Int
    PuzzleSet_Of_Event PuzzleSet_Of_Event @relation(fields: [puzzleSetOfEventId], references: [id])

    promotionOfEventId Int
    Promotion_Of_Event Promotion_Of_Event @relation(fields: [promotionOfEventId], references: [id])

    @@unique([puzzleSetOfEventId, promotionOfEventId])
}

model Game_Of_Event {
    id              Int     @id @default(autoincrement())
    gameId          Int
    gameName        String
    gameDescription String?

    eventId Int
    Event   Event @relation(fields: [eventId], references: [id])

    Reward_Rule_GameOfEvents        Reward_RuleFor_GameOfEvent[]
    UserJoinEvent_Join_GameOfEvents UserJoinEvent_Join_GameOfEvent[]
}

model Promotion_Of_Event {
    id                   Int     @id @default(autoincrement())
    promotionId          Int
    promotionName        String
    promotionDescription String?
    quantity             Int

    eventId Int
    Event   Event @relation(fields: [eventId], references: [id])

    PromotionOfEvent_For_PuzzleSetOfEvents PromotionOfEvent_Prize_PuzzleSetOfEvent[]
    UserJoinEvent_Has_PromotionOfEvent     UserJoinEvent_Has_PromotionOfEvent[]
}

enum Metric {
    TOP
    SCORE
}

enum RewardType {
    PROMOTION
    PUZZLE
}

model Reward_RuleFor_GameOfEvent {
    id        Int    @id @default(autoincrement())
    metric    Metric
    threshold Int

    gameOfEventId Int
    Game_Of_Event Game_Of_Event @relation(fields: [gameOfEventId], references: [id])

    rewardId Int
    Reward   Reward[]
}

model Reward {
    id                  Int        @id @default(autoincrement())
    promotionOrPuzzleId Int // Weak FK
    quantity            Int
    type                RewardType // Promotion or Puzzle

    rewardRuleForGameOfEventId Int
    Reward_RuleFor_GameOfEvent Reward_RuleFor_GameOfEvent? @relation(fields: [rewardRuleForGameOfEventId], references: [id])

    UserJoinEventJoinGameOfEventHistory_Has_ScoreReward UserJoinEventJoinGameOfEventHistory_Has_ScoreReward[]
    UserJoinEventJoinGameOfEvent_Has_TopReward          UserJoinEventJoinGameOfEvent_Has_TopReward[]

    @@unique([promotionOrPuzzleId, type, quantity])
}

model UserJoinEvent_Join_GameOfEvent {
    id   Int  @id @default(autoincrement())
    turn Int
    top  Int?

    gameOfEventId Int
    Game_Of_Event Game_Of_Event @relation(fields: [gameOfEventId], references: [id])

    userJoinEventId Int
    UserJoinEvent   User_Join_Event? @relation(fields: [userJoinEventId], references: [id])

    UserJoinEventJoinGameOfEvent_History       UserJoinEventJoinGameOfEvent_History[]
    UserJoinEventJoinGameOfEvent_Has_TopReward UserJoinEventJoinGameOfEvent_Has_TopReward[]

    @@unique([gameOfEventId, userJoinEventId])
}

model UserJoinEventJoinGameOfEvent_History {
    id    Int      @id @default(autoincrement())
    score Int
    date  DateTime

    userJoinEventJoinGameOfEventId Int
    UserJoinEvent_Join_GameOfEvent UserJoinEvent_Join_GameOfEvent @relation(fields: [userJoinEventJoinGameOfEventId], references: [id])

    UserJoinEventJoinGameOfEventHistory_Has_ScoreReward UserJoinEventJoinGameOfEventHistory_Has_ScoreReward[]

    @@unique([date, userJoinEventJoinGameOfEventId])
}

model UserJoinEventJoinGameOfEvent_Has_TopReward {
    id Int @id @default(autoincrement())

    userJoinEventJoinGameOfEventId Int
    UserJoinEventJoinGameOfEvent   UserJoinEvent_Join_GameOfEvent @relation(fields: [userJoinEventJoinGameOfEventId], references: [id])

    rewardId Int
    Reward   Reward @relation(fields: [rewardId], references: [id])

    @@unique([userJoinEventJoinGameOfEventId, rewardId])
}

model UserJoinEventJoinGameOfEventHistory_Has_ScoreReward {
    id Int @id @default(autoincrement())

    userJoinEventJoinGameOfEventHistoryId Int
    UserJoinEventJoinGameOfEventHistory   UserJoinEventJoinGameOfEvent_History @relation(fields: [userJoinEventJoinGameOfEventHistoryId], references: [id])

    rewardId Int
    Reward   Reward @relation(fields: [rewardId], references: [id])

    @@unique([userJoinEventJoinGameOfEventHistoryId, rewardId])
}
