// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
    // uncomment next line if you use Prisma <5.10
    // directUrl = env("DATABASE_URL_UNPOOLED")
}

enum EventStatus {
    PENDING
    APPROVED
    REJECTED
    STARTED
    ENDED
}

model Event {
    id          String      @id @default(uuid())
    partnerId   String
    partnerName String
    name        String
    description String?
    startDate   DateTime?
    endDate     DateTime?
    status      EventStatus

    UserJoinEvents      User_Join_Event[]
    PuzzleSet_Of_Events PuzzleSet_Of_Event[]
    Game_Of_Events      Game_Of_Event[]
    Promotion_Of_Events Promotion_Of_Event[]
}

model User_Join_Event {
    id            String   @id @default(uuid())
    userId        String
    userFirstName String
    userLastName  String
    userEmail     String
    userFacebook  String?
    joinDate      DateTime

    eventId String
    Event   Event  @relation(fields: [eventId], references: [id])

    UserJoinEvent_Has_Puzzles                UserJoinEvent_Has_PuzzleOfEvent[]
    UserJoinEvent_Exchange_PuzzleSetOfEvents UserJoinEvent_Exchange_PuzzleSetOfEvent[]
    UserJoinEvent_Join_GameOfEvent           UserJoinEvent_Join_GameOfEvent[]
    UserJoinEvent_Has_PromotionOfEvent       UserJoinEvent_Has_PromotionOfEvent[]

    @@unique([userId, eventId])
}

model UserJoinEvent_Has_PuzzleOfEvent {
    id       String @id @default(uuid())
    quantity Int

    userJoinEventId String
    UserJoinEvent   User_Join_Event @relation(fields: [userJoinEventId], references: [id])

    puzzleOfEventId String
    Puzzle_Of_Event Puzzle_Of_Event @relation(fields: [puzzleOfEventId], references: [id])

    @@unique([userJoinEventId, puzzleOfEventId])
}

model UserJoinEvent_Has_PromotionOfEvent {
    id       String @id @default(uuid())
    quantity Int

    promotionOfEventId String
    PromotionOfEvent   Promotion_Of_Event @relation(fields: [promotionOfEventId], references: [id])

    userJoinEventId String
    UserJoinEvent   User_Join_Event @relation(fields: [userJoinEventId], references: [id])

    @@unique([promotionOfEventId, userJoinEventId])
}

model UserJoinEvent_Exchange_PuzzleSetOfEvent {
    id           String   @id @default(uuid())
    exchangeDate DateTime

    PuzzleSet_Of_Event   PuzzleSet_Of_Event? @relation(fields: [puzzleSet_Of_EventId], references: [id])
    puzzleSet_Of_EventId String

    UserJoinEvent   User_Join_Event? @relation(fields: [userJoinEventId], references: [id])
    userJoinEventId String
}

// Array of PuzzleSet, outside.
model Puzzle_Of_Event {
    id         String @id @default(uuid())
    puzzleId   String
    puzzleName String

    puzzleSetOfEventId String
    PuzzleSet_Of_Event PuzzleSet_Of_Event @relation(fields: [puzzleSetOfEventId], references: [id])

    UserJoinEvent_Has_PuzzleOfEvent UserJoinEvent_Has_PuzzleOfEvent[]

    @@unique([puzzleId, puzzleSetOfEventId])
}

model PuzzleSet_Of_Event {
    id            String @id @default(uuid())
    puzzleSetId   String
    puzzleSetName String

    eventId String
    Event   Event  @relation(fields: [eventId], references: [id])

    Puzzle_Of_Events                        Puzzle_Of_Event[]
    PromotionOfEvent_For_PuzzleSetOfEvents  PromotionOfEvent_Prize_PuzzleSetOfEvent[]
    UserJoinEvent_Exchange_PuzzleSetOfEvent UserJoinEvent_Exchange_PuzzleSetOfEvent[]

    @@unique([puzzleSetId, eventId])
}

model PromotionOfEvent_Prize_PuzzleSetOfEvent {
    id       String @id @default(uuid())
    quantity Int

    puzzleSetOfEventId String
    PuzzleSet_Of_Event PuzzleSet_Of_Event @relation(fields: [puzzleSetOfEventId], references: [id])

    promotionOfEventId String
    Promotion_Of_Event Promotion_Of_Event @relation(fields: [promotionOfEventId], references: [id])

    @@unique([puzzleSetOfEventId, promotionOfEventId])
}

model Game_Of_Event {
    id              String  @id @default(uuid())
    gameId          String
    gameName        String
    gameDescription String?

    eventId String
    Event   Event  @relation(fields: [eventId], references: [id])

    Reward_Rule_GameOfEvents        Reward_RuleFor_GameOfEvent[]
    UserJoinEvent_Join_GameOfEvents UserJoinEvent_Join_GameOfEvent[]
}

model Promotion_Of_Event {
    id                   String  @id @default(uuid())
    promotionId          String
    promotionName        String
    promotionDescription String?
    quantity             Int

    eventId String
    Event   Event  @relation(fields: [eventId], references: [id])

    PromotionOfEvent_For_PuzzleSetOfEvents PromotionOfEvent_Prize_PuzzleSetOfEvent[]
    UserJoinEvent_Has_PromotionOfEvent     UserJoinEvent_Has_PromotionOfEvent[]
}

enum Metric {
    TOP
    SCORE
}

enum RewardType {
    PROMOTION
    PUZZLE
}

model Reward_RuleFor_GameOfEvent {
    id        String @id @default(uuid())
    metric    Metric
    threshold Int

    gameOfEventId String
    Game_Of_Event Game_Of_Event @relation(fields: [gameOfEventId], references: [id])

    rewardId String
    Reward   Reward[]
}

model Reward {
    id       String     @id @default(uuid())
    rewardId String // Weak FK @map("promotionOrPuzzleId")
    quantity Int
    type     RewardType // Promotion or Puzzle

    rewardRuleForGameOfEventId String
    Reward_RuleFor_GameOfEvent Reward_RuleFor_GameOfEvent? @relation(fields: [rewardRuleForGameOfEventId], references: [id])

    UserJoinEventJoinGameOfEventHistory_Has_ScoreReward UserJoinEventJoinGameOfEventHistory_Has_ScoreReward[]
    UserJoinEventJoinGameOfEvent_Has_TopReward          UserJoinEventJoinGameOfEvent_Has_TopReward[]

    @@unique([rewardId, type, quantity])
}

model UserJoinEvent_Join_GameOfEvent {
    id   String @id @default(uuid())
    turn Int
    top  Int?

    gameOfEventId String
    Game_Of_Event Game_Of_Event @relation(fields: [gameOfEventId], references: [id])

    userJoinEventId String
    UserJoinEvent   User_Join_Event? @relation(fields: [userJoinEventId], references: [id])

    UserJoinEventJoinGameOfEvent_History       UserJoinEventJoinGameOfEvent_History[]
    UserJoinEventJoinGameOfEvent_Has_TopReward UserJoinEventJoinGameOfEvent_Has_TopReward[]

    @@unique([gameOfEventId, userJoinEventId])
}

model UserJoinEventJoinGameOfEvent_History {
    id    String   @id @default(uuid())
    score Int
    date  DateTime

    userJoinEventJoinGameOfEventId String
    UserJoinEvent_Join_GameOfEvent UserJoinEvent_Join_GameOfEvent @relation(fields: [userJoinEventJoinGameOfEventId], references: [id])

    UserJoinEventJoinGameOfEventHistory_Has_ScoreReward UserJoinEventJoinGameOfEventHistory_Has_ScoreReward[]

    @@unique([date, userJoinEventJoinGameOfEventId])
}

model UserJoinEventJoinGameOfEvent_Has_TopReward {
    id String @id @default(uuid())

    userJoinEventJoinGameOfEventId String
    UserJoinEventJoinGameOfEvent   UserJoinEvent_Join_GameOfEvent @relation(fields: [userJoinEventJoinGameOfEventId], references: [id])

    rewardId String
    Reward   Reward @relation(fields: [rewardId], references: [id])

    @@unique([userJoinEventJoinGameOfEventId, rewardId])
}

model UserJoinEventJoinGameOfEventHistory_Has_ScoreReward {
    id String @id @default(uuid())

    userJoinEventJoinGameOfEventHistoryId String
    UserJoinEventJoinGameOfEventHistory   UserJoinEventJoinGameOfEvent_History @relation(fields: [userJoinEventJoinGameOfEventHistoryId], references: [id])

    rewardId String
    Reward   Reward @relation(fields: [rewardId], references: [id])

    @@unique([userJoinEventJoinGameOfEventHistoryId, rewardId])
}
